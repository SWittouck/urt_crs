---
title: "The URT microbiome of CRS patients: data analysis"
author: "Stijn Wittouck"
date: "December 18, 2018"
output:
  html_document:
    depth: 2
    number_sections: no
    theme: united
    toc: yes
    toc_float: yes
---

This Rmarkdown document describes the data analysis for the paper "Topographical diversity of the microbiome in the upper respiratory tract: focus on chronic rhinosinusitis" by De Boeck, Wittouck, Martens et al. (the title may have changed slightly). All data visualizations and summary tables shown in the paper are generated by this document. You can read this document to get a more detailed overview of the data analysis, or you can run the code yourself and play around with it if you want to explore the data on your own. The easiest way to run the code is to use [RStudio](https://www.rstudio.com/products/rstudio/#Desktop). 

You need sevaral R packages to be able to run the code. You can install those by uncommenting and running the following commands:

```{r}
# install.packages("tidyverse")
# install.packages("ggrepel")
# install.packages("ggpubr")
# install.packages("ggmosaic")
# install.packages("vegan")
# source("https://bioconductor.org/biocLite.R") # required to install phyloseq from bioconductor
# biocLite("phyloseq")
# install.packages("devtools") # required to install tidyamplicons from github
# install_github("SWittouck/tidyamplicos")
```

Enjoy! 

# Set-up

Settings for rendering of this markdown file: 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

Load the required R packages: 

```{r}
library(tidyverse)
library(ggrepel) # asv labels on scatterplots
library(ggpubr) # p-values on plots and composing figure panels
library(ggmosaic) # mosaic plot
library(vegan) # adonis
library(phyloseq) # rarefying
library(tidyamplicons)
```

Make a resuls folder: 

```{r}
dout <- "results"
if (! dir.exists(dout)) dir.create(dout)
```

Function to assign a letter to a subplot in a panel (we will need this throughout the document):

```{r}
give_letter <- function(plot, letter) {
  
  g <- ggplotGrob(plot + ggtitle(letter))
  g$layout$l[g$layout$name == "title"] <- 1
  
  g
  
}
```

# Data preparation

We start by loading the data. All data is bundled in a "tidyamplicons" object: it contains the read counts of all taxa (ASVs) in all samples, the metadata of the samples (sampling location, patient characteristics, ...) and metadata of the taxa (taxonomic classification and interpretable taxon names). 

```{r}
load("data/urt.rda")
```

Create a separate tidyamplicons object with abundances aggregated on the genus level: 

```{r}
urt_genus <- 
  urt %>%
  select_taxa(- species, - taxon_name) %>%
  aggregate_taxa()
get_numbers(urt_genus)
```

Create a separate tidyamplicons object where the samples are rarefied to 1000 reads (samples with less reads will be dropped): 

```{r}
urt_r <- 
  urt %>%
  add_lib_size() %>%
  filter_samples(lib_size >= 1000) %>%
  as_phyloseq() %>%
  rarefy_even_depth(sample.size = 1000, rngseed = 1991) %>%
  tidy_phyloseq() 
get_numbers(urt_r)
```

Define the order of the sampling locations for figures:

```{r}
locs <- c("anterior nares", "nasopharynx", "maxillary sinus", "ethmoid sinus")
```

# Exploration of metadata

Now that we prepared the dataset, we would like to explore the metadata of all CRS patients with at least one high-quality sample. The names of all metadata variables on the level of the participants (e.g. age), not samples (e.g. sampling location) is stored in a txt file called "variables.txt".

```{r}
predictors <- read_csv("input/variables.txt")
crs_patients <- 
  urt %>%
  filter_samples(condition == "CRS") %>%
  samples() %>%
  select(participant, one_of(predictors$predictor)) %>%
  distinct()
write_csv(crs_patients, "results/metadata.csv")
```

## Numerical variables (discrete and continuous)

Let's make a summary table of the numerical variables (both discrete and continuous ones). For each variable, we list the number of CRS patients that have data available, plus the mean and standard deviation of the variable: 

```{r}
av_table <- 
  crs_patients %>%
  select(!! predictors %>% filter(level != "cat") %>% pull(predictor)) %>%
  gather(value = "value", key = "variable", tidyselect::everything()) %>%
  group_by(variable) %>%
  summarize(
    not_na = value %>% na.omit %>% length,
    mean = mean(value, na.rm = T),
    sd = sd(value, na.rm = T)
  )
write_csv(av_table, file.path(dout, "predictors_summary_num.csv"))
```

We can also explore the variables in a visualization: 

```{r}
crs_patients %>%
  select(!! predictors %>% filter(level == "disc") %>% pull(predictor)) %>%
  gather(value = "value", key = "variable", tidyselect::everything()) %>%
  ggplot(aes(x = value)) + 
  geom_bar() + 
  facet_wrap(~ variable, ncol = 1, scales = "free")
ggsave(paste0(dout, "/expl_predictors_discrete.png"), units = "cm", width = 40, height = 20)
crs_patients %>%
  select(!! predictors %>% filter(level == "cont") %>% pull(predictor)) %>%
  gather(value = "value", key = "variable", tidyselect::everything()) %>%
  ggplot(aes(x = value)) + 
  geom_density() + 
  facet_wrap(~ variable, ncol = 1, scales = "free")
ggsave(paste0(dout, "/expl_predictors_continuous.png"), units = "cm", width = 40, height = 20)
```

## Categorical variables

For the categorical variables we can make a frequency table: 

```{r}
freq_table <- 
  crs_patients %>%
  select(!! predictors %>% filter(level == "cat") %>% pull(predictor)) %>%
  gather(value = "value", key = "variable", tidyselect::everything()) %>%
  count(variable, value)
write_csv(freq_table, file.path(dout, "predictors_summary_cat.csv"))
```

Visualization: 

```{r}
freq_table %>%
  ggplot(aes(x = value, y = n)) + 
  geom_col() + 
  coord_flip() + 
  facet_wrap(~ variable, scales = "free")
ggsave(paste0(dout, "/expl_predictors_categorical.png"), units = "cm", width = 20, height = 15)
```

# Results 1: comparison between niches

In the first results section, we compare the microbiomes of CRS patients between four niches (sampling locations): the nose (anterior nares), the nasopharynx, te maxillary sinus and the ethmoid sinus. 

## Top eleven genera (genus level)

In a first explorative plot, we visualize each sample as a vertical bar and give the eleven most abundant genera (overall) a color. In addition, we group the samples by niche:

```{r}
(
  fig_niches_bar <- 
    urt_genus %>%
    filter_samples(condition == "CRS") %>%
    add_taxon_name_color(method = "total_rel_abundance") %>%
    modify_at("samples", mutate_at, "location", recode, 
      N = "anterior nares", 
      NF = "nasopharynx",
      SE = "ethmoid sinus",
      SM = "maxillary sinus"
    ) %>%
    modify_at("samples", mutate_at, "location", factor, levels = locs) %>%
    get_bar_plot() +
    scale_fill_brewer(palette = "Paired", name = "genus") +
    facet_wrap(~ location, scales = "free_x", ncol = 1) +
    theme_bw() +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(), 
      legend.position = "right",
      plot.margin = unit(c(0, 1, 0, 0), "cm")
    )
)
ggsave(paste0(dout, "/niches_bar.png"), units = "cm", width = 40, height = 20)
```

The genus name FM873692_g is not really interpretable; some research at the [EzBioCloud](https://www.ezbiocloud.net/) website learns us that it is a genus of the family Neisseriaceae. 

We can also make a list of the overall most abundant genera in the CRS patients, across all niches: 

```{r}
urt_genus %>%
  filter_samples(condition == "CRS") %>%
  add_mean_rel_abundances() %>%
  taxa() %>%
  arrange(desc(mean_rel_abundance)) %>%
  select(genus, mean_rel_abundance) %>%
  print(n = 20)
```

## Alpha diversity (asv level)

After our initial exploration, we can compare the four niches on their diversity, i.e. how many taxa samples from those niches contain on average. 

We make a figure that shows the comparison between the four niches of two different alpha diversity measures: the ASV richness (simple count of the number of ASVs per sample) and the inverse Simpson measure. The latter takes "evenness" of the relative abundances into account; a sample will have a lower inverse Simpson when a few (or one) samples are very dominent (or even one sample in the extreme case). We first store the figure without plotting, so we can later make a variant with p-values and one with stars that represent significance levels: 

```{r}
fig_niches_div_raw <- 
  urt_r %>%
  filter_samples(condition == "CRS") %>%
  filter_samples(location %in% c("N", "NF", "SM", "SE")) %>%
  add_diversity_measures() %>%
  pluck("samples") %>%
  mutate_at("location", recode, 
    N = "anterior nares", NF = "nasopharynx", SM = "maxillary sinus", SE = "ethmoid sinus"
  ) %>%
  mutate_at("location", factor, levels = locs) %>%
  select(sample, participant, location, contains("div")) %>%
  gather(value = "diversity", key = "metric", contains("div"))%>%
  mutate_at("metric", recode,
    div_inv_simpson = "inverse Simpson", 
    div_observed = "richness"
  ) %>%
  ggplot(aes(x = location, y = diversity)) +
  geom_boxplot(fill = "grey90", col = "grey60", outlier.alpha = 0) +
  geom_jitter(width = 0.1, height = 0, alpha = 1, size = 1) +
  facet_wrap(~ metric, scales = "free_y", ncol = 1) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
```

Remark: we have used the rarefied data for this; otherwise a sample with many reads would tend to seem more diverse. 

Figure with significance levels: 

```{r}
(
  fig_niches_div <- 
    fig_niches_div_raw + 
    stat_compare_means(
      method = "t.test", paired = F, label = "p.signif", hide.ns = T,
      comparisons = list(c(1, 2), c(1, 3), c(1, 4), c(2, 3), c(2, 4), c(3, 4)),
      size = 2
    )
)
ggsave(paste0(dout, "/niches_div.png"), units = "cm", width = 20, height = 20)
```

Figure with p-values:

```{r}
fig_niches_div_raw + 
  stat_compare_means(
    method = "t.test", paired = F, label = "p.format", hide.ns = F,
    comparisons = list(c(1, 2), c(1, 3), c(1, 4), c(2, 3), c(2, 4), c(3, 4))
  )
ggsave(paste0(dout, "/niches_div_pvalues.png"), units = "cm", width = 40, height = 40)
```

## Beta diversity (asv level)

Pairwise beta diversity is a measure for how similar (or different) two samples are. We use the Bray-Curtis dissimilarity (because of rather technical reasons, we should not call it a distance), which can be interpreted as the percentage of the contents of one sample that is not present in the other one. 

If we try to make a two-dimensional scatterplot of the samples where the distances between the points are as close as possible (relatively speaking) to the Bray-Curtis distances, we are making a principal coordinates analysis (PCoA) plot: 

```{r}
urt %>%
  filter_samples(condition == "CRS") %>%
  add_pcoa() %>%
  pluck("samples") %>%
  ggplot(aes(x = pcoa1, y = pcoa2, col = location)) +
  geom_point() +
  scale_color_brewer(palette = "Paired") +
  xlab("PCoA component 1") +
  ylab("PCoA component 2") + 
  theme_bw()
ggsave(paste0(dout, "/figure_S1_pcoa.tiff"), units = "cm", width = 20, height = 15)
```

The PCoA plot is an approximation in two dimensions; a lot of information gets lost. Now we will visualize all pairwise Bray-Curtis distances. Calculating those distances happened "under the hood" when we used the `add_pcoa()` function. Therefore, we have to calculate them again, this time to store them in a table: 

```{r}
crs <- filter_samples(urt, condition == "CRS")
betas <- 
  crs %>%
  get_betas(method = "bray", binary = F) %>%
  split(f = if_else(.$location_1 >= .$location_2, "yes", "no")) %>%
  modify_at("no", mutate, location_1_new = location_2, location_2_new = location_1) %>%
  modify_at("no", mutate, location_1 = location_1_new, location_2 = location_2_new) %>%
  modify_at("no", select, - location_1_new, - location_2_new) %>%
  do.call(what = bind_rows)
```

Now we visualize all those distances in boxplots, grouped per type of "comparison" that they represent: 

```{r}
locations_levels <- c(
  "N_N", "NF_NF", "SM_SM", "SE_SE",
  "NF_N", "SE_N", "SM_N", "SE_NF", "SM_NF", "SM_SE"
)

locations_labels <- c(
  "anterior nares",
  "nasopharynx",
  "maxillary sinus",
  "ethmoid sinus",
  "nasopharynx - anterior nares",
  "ethmoid sinus - anterior nares",
  "maxillary sinus - anterior nares",
  "ethmoid sinus - nasopharynx",
  "maxillary sinus - nasopharynx",
  "maxillary sinus - ethmoid sinus"
)

(
  fig_niches_betas <- 
    betas %>%
    mutate(bray_simil = 1 - beta) %>%
    mutate(locations = str_c(location_1, location_2, sep = "_")) %>%
    mutate_at("locations", factor, levels = locations_levels, labels = locations_labels) %>%
    mutate(same_participant = if_else(participant_1 == participant_2,
      "same participant", "different participant"
    )) %>%
    mutate(same_location = if_else(location_1 == location_2,
      "same location", "different location"
    )) %>%
    mutate_at("same_location", factor, levels = c("same location", "different location")) %>% 
    ggplot(aes(x = locations, y = bray_simil, col = locations)) +
    geom_boxplot(alpha = 0.5, outlier.alpha = 0) +
    geom_jitter(width = 0.1, height = 0, alpha = 1, size = 1) +
    facet_grid(~ same_participant + same_location, scales = "free_x", space = "free_x") +
    scale_color_brewer(palette = "Paired") + 
    ylab("bray-curtis similarity") +
    theme_bw() +
    theme(axis.text.x = element_blank())
)
ggsave(paste0(dout, "/niches_betas.png"), units = "cm", width = 30, height = 20)
```

Finally, we perform an adonis test with the variables location (niche) and participant als predictors. This will tell us if the microbiome differs significantly between the locations (within participants) and/or between the participants (within locations). 

```{r}
perform_adonis(crs, predictors = c("location", "participant"))
```

## Panel

We arrange the figures of results section 1 into one large panel: 

```{r}
ggarrange(
  fig_niches_bar %>% give_letter("A"), 
  ggarrange(
    fig_niches_div %>% give_letter("B"), 
    fig_niches_betas %>% give_letter("C"),
    ncol = 2, widths = c(3, 5)
  ),
  nrow = 2,
  heights = c(1, 1)
)
ggsave(paste0(dout, "/figure_1.tiff"), units = "cm", width = 30, height = 30)
```

# Results 2: comparison with healthy subjects

In the second results section, we compare the microbiome of the CRS patients to that of ~ 100 healthy volunteers. 

## Overall adonis

Adonis with "condition" (CRS/CON) as prediction, on the nose samples only:

```{r}
urt %>%
  filter_samples(location == "N") %>%
  perform_adonis(predictors = "condition")
```

Same test, this time on the nasopharynx samples: 

```{r}
urt %>%
  filter_samples(location == "NF") %>%
  perform_adonis(predictors = "condition")
```

## Alpha diversity (asv level)

Here we compare alpha diversity (richness and inverse Simpson) between: healthy, CRS with polyps and CRS without polyps. We exclude CRS patients with polyps NA. 

First the raw figure without p-values or significance levels: 

```{r}
fig_conditions_div_raw <- 
  urt_r %>%
  filter_samples(location %in% c("N", "NF")) %>%
  add_diversity_measures() %>%
  pluck("samples") %>%
  mutate_at("location", recode, 
    N = "anterior nares", NF = "nasopharynx"
  ) %>%
  mutate_at("location", factor, levels = locs) %>%
  mutate(
    case = 
      case_when(
        condition == "CON" ~ "healthy",
        polyps == 0 ~ "CRSsNP",
        polyps == 1 ~ "CRSwNP",
        is.na(polyps) ~ "crs (polyps NA)"
      )
  ) %>%
  filter(case != "crs (polyps NA)") %>%
  mutate(
    case = 
      factor(case, levels = c("healthy", "CRSsNP", "CRSwNP"))
  ) %>%
  select(sample, case, location, contains("div")) %>%
  gather(value = "diversity", key = "metric", contains("div"))%>%
  mutate_at(
    "metric", recode,
    div_inv_simpson = "inverse Simpson", 
    div_observed = "richness"
  ) %>%
  ggplot(aes(x = case, y = diversity)) +
  geom_boxplot(fill = "grey90", col = "grey60", outlier.alpha = 0) + 
  scale_color_brewer(palette = "Paired") + 
  geom_jitter(width = 0.1, height = 0, alpha = 1, size = 1) +
  facet_grid(metric ~ location, scales = "free_y") +
  theme_bw()
```

Figure with significance values: 

```{r}
(
  fig_conditions_div <- 
    fig_conditions_div_raw + 
    stat_compare_means(
      method = "t.test", paired = F, label = "p.signif", hide.ns = T,
      comparisons = list(c(1, 2), c(1, 3), c(2, 3))
    )
)
ggsave(paste0(dout, "/figure_2.tiff"), units = "cm", width = 25, height = 20)
```

Figure with p-values: 

```{r}
fig_conditions_div_raw + 
  stat_compare_means(
    method = "t.test", paired = F, label = "p.format", hide.ns = F,
    comparisons = list(c(1, 2), c(1, 3), c(2, 3))
  )
ggsave(paste0(dout, "/conditions_div_pvalues.png"), units = "cm", width = 25, height = 20)
```

## Differential presence (asv level)

In this part, we compare the occurrence of ASVs between the CRS and CON subjects. More specifically, we look for ASVs that are significantly more present in one of the two subject groups than in the other. 

We first define a function that is able to make a "presence/absence table" with for each ASV: the percentage of CRS samples it is present in, the percentage of CON samples it is present in and the p-value of a fischer exact test to see if it is significantly more present in one of the groups. 

```{r}
pres_abs_table <- function(ta) {
  
  ta %>%
    add_occurrences(condition = "condition", relative = T, fischer_test = T)  %>%
    taxa() %>%
    mutate(
      fisher_sign = if_else(fisher_p < 0.05, "p < 0.05", "p >= 0.05"),
      taxon_name_plot = if_else(
        (occurrence_in_CON > 0.25 | occurrence_in_CRS > 0.25) & fisher_p < 0.05, 
        taxon_name, as.character(NA)
      ) 
    )
  
}
```

We create a separate presence/absence table for nose and nasopharynx samples and we merge them: 

```{r}
pres_nose <- 
  urt_r %>%
  filter_samples(location == "N") %>%
  pres_abs_table() %>%
  mutate(location = "anterior nares")
pres_npx <- 
  urt_r %>%
  filter_samples(location == "NF") %>%
  pres_abs_table() %>%
  mutate(location = "nasopharynx")
pres_table <- 
  bind_rows(pres_nose, pres_npx) %>%
  mutate(location = factor(location, levels = c("anterior nares", "nasopharynx")))
```

Now we can visualize the "occurrences" and fischer exact test significances in a scatteplot: 

```{r}
(
  fig_conditions_pres <- 
    pres_table %>%
    ggplot(aes(x = occurrence_in_CON, y = occurrence_in_CRS, col = fisher_sign)) +
    geom_point() +
    geom_label_repel(aes(label = taxon_name_plot)) +
    scale_color_manual(
      values = c("p < 0.05" = "#1f78b4", "p >= 0.05" = "#a6cee3"), 
      name = "fisher exact test"
    ) +
    stat_function(fun = function(x) x, col = "grey") +
    facet_wrap(~ location, nrow = 1) + 
    xlim(c(0, 1)) + ylim(c(0, 1)) +
    xlab("presence in CON samples") +
    ylab("presence in CRS samples") +
    theme_bw() 
)
ggsave(paste0(dout, "/conditions_pres.png"), units = "cm", width = 35, height = 15)
```

## Differential abundance (asv level)

This part is similar to the previous part, but here we determine the mean relative abundances of all taxa in the CON and CRS groups, and whether those differ significantly (using a t-test). 

```{r}
ab_nose <- 
  urt %>%
  filter_samples(location == "N") %>%
  add_mean_rel_abundances("condition", t_test = T) %>%
  pluck("taxa") %>%
  mutate(location = "anterior nares")
ab_npx <- 
  urt %>%
  filter_samples(location == "NF") %>%
  add_mean_rel_abundances("condition", t_test = T) %>%
  pluck("taxa") %>%
  mutate(location = "nasopharynx")
ab_table <- 
  bind_rows(ab_nose, ab_npx) %>%
  mutate(location = factor(location, levels = c("anterior nares", "nasopharynx"))) %>%
  mutate(
    t_test_sign = if_else(t_test_p < 0.05, "p < 0.05", "p >= 0.05"),
    taxon_name_plot = if_else(
      (mean_rel_abundance_in_CON > 0.03 | mean_rel_abundance_in_CRS > 0.03), 
      taxon_name, as.character(NA)
    ) 
  )
```

Visualize differential abundances in a scatterplot: 

```{r}
(
  fig_conditions_abun <- 
    ab_table %>%
    ggplot(aes(x = mean_rel_abundance_in_CON, y = mean_rel_abundance_in_CRS, col = t_test_sign)) +
    geom_point() +
    geom_label_repel(
      aes(label = taxon_name_plot)
    ) +
    stat_function(fun = function(x) x, col = "grey") +
    scale_color_manual(values = c("p < 0.05" = "#1f78b4", "p >= 0.05" = "#a6cee3"), name = "t-test") +
    facet_wrap(~ location, nrow = 1) +
    xlim(c(0, 0.20)) + ylim(c(0, 0.20)) +
    xlab("mean relative abundance in CON samples") +
    ylab("mean relative abundance in CRS samples") +
    theme_bw() 
)
ggsave(paste0(dout, "/conditions_abun.png"), units = "cm", width = 35, height = 15)
```

## Panel

We put the differential occurrences and differential abundances together in one figure panel:

```{r}
ggarrange(
  fig_conditions_pres %>% give_letter("A"), 
  fig_conditions_abun %>% give_letter("B"),
  ncol = 1, nrow = 2
)
ggsave(paste0(dout, "/figure_3.tiff"), units = "cm", width = 35, height = 30)
```

# Results 3: assocations with metadata

In this final results section, we check for associations between the microbiome of the CRS patients and various types of metadata: patient characteristics (such as age), phenotypes (such as allergies) and endotypes (such as IL-5 blood levels). We do this only for the nasopharynx samples. 

## Associations with metadata (asv level)

We make a separate tidyamplicons object with only the nasopharynx samples of CRS patients: 

```{r}
crs_nf <- filter_samples(urt, condition == "CRS", location == "NF")
```

One very important variable that divides the CRS patients into two subgroups is whether they have polyps. We first check if this variable is associated with the microbiome using an adonis test: 

```{r}
perform_adonis(crs_nf, "polyps")
```

Now we perform an adonis test for all predictors, separately on the CRSsNP and CRSwNP groups: 

```{r}
predictors_enriched <- 
  predictors %>%
  filter(predictor != "polyps") %>%
  mutate(CRSsNP = map(predictor, ~ perform_adonis(
    crs_nf %>% filter_samples(polyps == 0), .
  ))) %>%
  mutate(CRSwNP = map(predictor, ~ perform_adonis(
    crs_nf %>% filter_samples(polyps == 1), .
  ))) %>%
  mutate(all_subjects = map(predictor, ~ perform_adonis(
    crs_nf, .
  ))) %>%
  gather(key = "polyps", value = "adonis", CRSsNP, CRSwNP, all_subjects) %>%
  mutate(R2 = map_dbl(adonis, list("aov.tab", "R2", 1))) %>%
  mutate(p = map_dbl(adonis, list("aov.tab", "Pr(>F)", 1))) %>%
  mutate(n = map_int(adonis, ~ nrow(.[["model.matrix"]]))) %>%
  select(- adonis) %>%
  mutate(sign = p < 0.05)
predictors_enriched %>%
  write_csv("results/predictors_pvalues.csv")
```

Visualize results:

```{r}
predictors_enriched %>%
  arrange(polyps, R2) %>%
  mutate(predictor = factor(predictor, levels = unique(predictor))) %>%
  ggplot(aes(x = predictor, y = R2, fill = type, shape = sign)) +
  geom_col() +
  geom_point(size = 5) + 
  geom_text(aes(label = n, y = - 0.001)) + 
  facet_wrap(~ polyps) +
  scale_fill_brewer(
    palette = "Paired",
    guide = guide_legend(override.aes = list(shape = NA), title = "type of predictor")
  ) + 
  scale_shape_manual(
    values = c(`TRUE` = 42, `FALSE` = 32),
    guide = guide_legend(title = "significant")
  ) +
  coord_flip() +
  theme_bw() 
ggsave(paste0(dout, "/figure_4.tiff"), units = "cm", width = 30, height = 10)
```

In our previous paper on the URT microbiome of healthy volunteers, we found a significant association between the microbiome and smoking. Let's visualize this variable (smoking) on a bar chart of the nasopharynx samples: 

```{r}
crs_nf %>%
  get_bar_plot() +
  geom_rug(data = crs_nf$samples, aes(x = sample, col = as.factor(smoking), fill = NULL, y = NULL)) +
  scale_color_brewer(palette = "Paired") +
  theme(axis.text.x = element_blank())
```

## Association of microbiome clusters with metadata (genus level)

In this subsection, we inspect the associations of the microbiome with the metadata in a bit more detail by dividing our CRS subject population in different "microbiome types" extracted from a hierarchical clustering. We extract fourteen clusters from the clustering tree and remove clusters with less than five samples. 

```{r}
crs_genus_clusters <- 
  urt_genus %>%
  filter_samples(condition == "CRS") %>%
  filter_samples(location == "NF") %>%
  add_cluster(n_clusters = 14) %>%
  modify_at("samples", add_count, cluster) %>%
  filter_samples(n >= 5)
crs_genus_clusters %>%
  get_bar_plot() +
  geom_point(aes(y = - 0.05, col = cluster)) +
  scale_color_brewer(palette = "Paired") +
  theme(
    axis.text.x = element_blank()
  )
ggsave(paste0(dout, "/figure_S2_clusters.tiff"), units = "cm", width = 30, height = 20)
```

Now we can create a summary table, with the mean of all numerical predictors per "subject cluster". 

```{r}
crs_genus_clusters %>%
  samples() %>%
  select(
    cluster, 
    one_of(predictors %>% filter(level != "cat") %>% pull(predictor))
  ) %>%
  group_by(cluster) %>%
  summarize_all(mean, na.rm = T)
```

Exploratory visualization of the numerical predictors: 

```{r}
(
  fig_predictors_num <- 
    crs_genus_clusters %>%
    samples() %>%
    select(
      cluster, 
      one_of(predictors %>% filter(level != "cat") %>% pull(predictor))
    ) %>%
    gather(key = "predictor", value = "value", - cluster) %>%
    ggplot(aes(x = cluster, y = value)) + 
    geom_boxplot(outlier.alpha = 0) + 
    geom_jitter(height = 0, width = 0.2, alpha = 1, col = "grey") + 
    facet_wrap(~ predictor, scales = "free_y", ncol = 2) +
    theme_bw()
)
ggsave(paste0(dout, "/predictors_num.png"), units = "cm", width = 20, height = 15)
```

Exploratory visulizations of the categorical predictors: 

```{r}
predictors_tidy <- 
  crs_genus_clusters %>%
  samples() %>%
  select(
    cluster, 
    one_of(predictors %>% filter(level == "cat") %>% pull(predictor))
  ) %>%
  mutate(male = gender == "M") %>%
  select(- gender) %>%
  gather(key = "predictor", value = "value", - cluster) %>%
  mutate_at("value", as.character) %>%
  filter(! is.na(value))

predictors_tidy %>%
  ggplot(aes(x = cluster, fill = value)) + 
  geom_bar(position = "stack") + 
  facet_wrap(~ predictor, scales = "free", ncol = 2) +
  scale_fill_brewer(palette = "Paired") + 
  theme_bw()
ggsave(paste0(dout, "/predictors_cat_1.png"), units = "cm", width = 20, height = 15)

predictors_tidy %>%
  ggplot(aes(x = value, y = cluster)) +
  geom_count(aes(col = ..n..)) +
  facet_wrap(~ predictor) + 
  theme_bw()
ggsave(paste0(dout, "/predictors_cat_2.png"), units = "cm", width = 20, height = 15)

(
  fig_predictors_cat <-
    predictors_tidy %>%
    mutate(value = if_else(value == 1, "yes", "no")) %>%
    ggplot() +
    geom_mosaic(aes(x = product(value, cluster), fill = value)) +
    coord_flip() + 
    facet_wrap(~ predictor) +
    scale_fill_brewer(palette = "Paired") + 
    theme_bw() +
    theme(
      axis.title = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.x = element_blank(),
      panel.grid = element_blank()
    )
)
ggsave(paste0(dout, "/predictors_cat_3.png"), units = "cm", width = 20, height = 15)

predictors_tidy %>%
  mutate(value = if_else(value == 1, "yes", "no")) %>%
  ggplot() +
  geom_mosaic(aes(x = product(cluster, value), fill = cluster)) +
  coord_flip() + 
  facet_wrap(~ predictor) +
  scale_fill_brewer(palette = "Paired") + 
  theme_bw() +
  theme(
    axis.title = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    panel.grid = element_blank()
  )
ggsave(paste0(dout, "/predictors_cat_4.png"), units = "cm", width = 20, height = 15)
```

## Panel

Again, we can put the exploratory visualizatons of the predictors vs the subject clusters in a figure panel: 

```{r}
ggarrange(
  fig_predictors_num %>% give_letter("A"), 
  fig_predictors_cat %>% give_letter("B"), 
  ncol = 1, nrow = 2
)
ggsave(paste0(dout, "/figure_5.tiff"), units = "cm", width = 35, height = 30)
```

